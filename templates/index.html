<!-- FILE: templates/index.html -->
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Link Processor</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* All previous styles are correct and unchanged */
        .container { max-width: 960px; } .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; margin-bottom: 2rem; } .navbar-brand { display: flex; align-items: center; gap: 1rem; font-weight: bold; font-size: 1.2rem; } .navbar-brand img { height: 40px; } #theme-toggle { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; padding: 0; } .form-box { text-align: center; } input[type="file"] { display: none; } .file-upload-wrapper { border: 2px dashed var(--pico-form-element-border-color); padding: 2rem; text-align: center; cursor: pointer; margin-bottom: 1rem; transition: border-color 0.2s; } .file-upload-wrapper:hover { border-color: var(--pico-primary); } #filename-display { margin-top: 1rem; font-style: italic; color: var(--pico-muted-color); } .grid { grid-template-columns: 1fr 1fr; } .instructions { margin-top: 4rem; text-align: left; } .instructions-grid { display: grid; gap: 2rem; margin-top: 2rem; grid-template-columns: repeat(2, 1fr); } .instructions-grid .material-symbols-outlined { font-size: 48px; color: var(--pico-primary); } @media (max-width: 768px) { .instructions-grid { grid-template-columns: 1fr; } .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header> <!-- Header is unchanged -->
            <nav class="navbar"><div class="navbar-brand"><img src="/static/logo.png" alt="App Logo"><span>PDF Link Processor</span></div><button id="theme-toggle" class="secondary outline"><span class="material-symbols-outlined">light_mode</span></button></nav>
        </header>
        <main>
            <article class="form-box">
                <header><h2>Analyze PDF Links Fast and Easy</h2></header>
                <form id="process-form">
                    <fieldset id="form-fieldset"> <!-- NEW: Fieldset to easily disable the form -->
                        <label for="pdf_file_input" class="file-upload-wrapper"><span role="button">Choose a PDF File</span><div id="filename-display">No file selected</div></label>
                        <input type="file" name="pdf_file" id="pdf_file_input" required>
                        <div class="grid">
                            <label for="keywords">Keywords<textarea name="keywords" id="keywords" rows="4">please call bass tool
no items found that match</textarea></label>
                            <label for="highlight_color">Highlight Color<select id="highlight_color" name="highlight_color"><option value="Yellow" selected>Yellow</option><option value="Pink">Pink</option><option value="Green">Green</option><option value="Blue">Blue</option></select></label>
                        </div>
                        <fieldset><legend><strong>Select Outputs</strong></legend>
                            <label><input type="checkbox" name="outputs" value="excel" checked> Excel Report</label>
                            <label><input type="checkbox" name="outputs" value="highlighted" checked> Highlighted PDF</label>
                            <label><input type="checkbox" name="outputs" value="extracted"> Extracted Pages</label>
                            <label><input type="checkbox" name="outputs" value="sorted"> Extracted & Sorted Pages</label>
                        </fieldset>
                        <button type="submit" id="submit-button">Start Processing â†’</button>
                    </fieldset>
                </form>
            </article>

            <section id="results-section" style="display:none; margin-top: 2rem;">
                <article>
                    <header style="display:flex; justify-content:space-between; align-items:center;">
                        <h4>Processing Live Log</h4>
                        <!-- NEW: Cancel Button -->
                        <button id="cancel-button" class="secondary outline">Cancel</button>
                    </header>
                    <progress id="progress-bar" value="0" max="100"></progress>
                    <small id="progress-text">Initializing...</small>
                    <div id="results-container" style="margin-top: 1rem;"></div>
                </article>
            </section>
        </main>
    </div>

    <script>
        // Theme and file input scripts are unchanged
        const themeToggle = document.getElementById('theme-toggle'); const themeIcon = themeToggle.querySelector('.material-symbols-outlined'); const htmlElement = document.documentElement; function setTheme(theme) { htmlElement.setAttribute('data-theme', theme); themeIcon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode'; localStorage.setItem('theme', theme); } themeToggle.addEventListener('click', () => { const currentTheme = htmlElement.getAttribute('data-theme'); setTheme(currentTheme === 'dark' ? 'light' : 'dark'); }); const savedTheme = localStorage.getItem('theme') || 'light'; setTheme(savedTheme);
        const fileInput = document.getElementById('pdf_file_input'); const filenameDisplay = document.getElementById('filename-display'); fileInput.addEventListener('change', () => { if (fileInput.files.length > 0) { filenameDisplay.textContent = fileInput.files[0].name; } else { filenameDisplay.textContent = 'No file selected'; } });

        // --- NEW: Enhanced SSE Form Submission ---
        const form = document.getElementById('process-form');
        const formFieldset = document.getElementById('form-fieldset');
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-button');
        const resultsSection = document.getElementById('results-section');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const resultsContainer = document.getElementById('results-container');
        let eventSource; // Keep a reference to close it

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            formFieldset.disabled = true; // Disable the form
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = '';
            progressText.textContent = 'Uploading file and starting process...';
            progressBar.removeAttribute('value');

            // Construct form data for GET request (works better with streaming)
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const pair of formData) {
                // Handle multiple checkboxes with the same name
                if (params.has(pair[0])) { params.append(pair[0], pair[1]); }
                else { params.set(pair[0], pair[1]); }
            }
            
            // We need to send the file separately via POST
            const fileData = new FormData();
            fileData.append('pdf_file', fileInput.files[0]);

            // First, upload the file, then start listening for events
            fetch(`/process?${params.toString()}`, {
                method: 'POST',
                body: fileData
            }).then(response => {
                const streamUrl = response.headers.get('X-Stream-Location');
                if (streamUrl) {
                    eventSource = new EventSource(streamUrl);
                    
                    eventSource.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        progressBar.setAttribute('value', data.progress);
                        progressBar.setAttribute('max', data.total);
                        progressText.textContent = data.message;
                    };

                    eventSource.addEventListener('complete', function(event) {
                        resultsContainer.innerHTML = event.data;
                        progressText.textContent = 'All tasks complete.';
                        eventSource.close();
                        formFieldset.disabled = false; // Re-enable form
                    });

                    eventSource.addEventListener('error', function(event) {
                        resultsContainer.innerHTML = `<p style="color:red;"><strong>Error:</strong> ${event.data}</p>`;
                        progressText.textContent = 'Failed.';
                        progressBar.setAttribute('value', '0');
                        eventSource.close();
                        formFieldset.disabled = false; // Re-enable form
                    });
                }
            }).catch(error => {
                resultsContainer.innerHTML = `<p style="color:red;">A connection error occurred. Please try again.</p>`;
                formFieldset.disabled = false; // Re-enable form
            });
        });

        cancelButton.addEventListener('click', function() {
            if (eventSource) {
                eventSource.close();
                progressText.textContent = 'Process canceled by user.';
                resultsContainer.innerHTML = '';
                formFieldset.disabled = false;
            }
        });
    </script>
</body>
</html>